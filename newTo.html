<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gray-50">
  <?!= include('nav'); ?>

  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-semibold text-gray-900 mb-6">New Travel Order</h2>

      <form id="toForm" class="space-y-6">
        <div>
          <label for="datePrepared" class="block text-sm font-medium text-gray-700 mb-2">Date Prepared *</label>
          <input type="date" id="datePrepared" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p id="datePreparedError" class="text-sm text-red-500 mt-1 hidden"></p>
        </div>

        <div>
          <label for="inclusiveDates" class="block text-sm font-medium text-gray-700 mb-2">Inclusive Dates *</label>
          <input type="text" id="inclusiveDates" placeholder="Select date range" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p id="inclusiveDatesError" class="text-sm text-red-500 mt-1 hidden"></p>
        </div>

        <div>
          <label for="destination" class="block text-sm font-medium text-gray-700 mb-2">Destination *</label>
          <input type="text" id="destination" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">Purpose *</label>
          <textarea id="purpose" rows="3" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>

        <div>
          <label for="requestedBy" class="block text-sm font-medium text-gray-700 mb-2">Requested By *</label>
          <input type="text" id="requestedBy" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="requestingOfficer" class="block text-sm font-medium text-gray-700 mb-2">Requesting Officer *</label>
          <input type="text" id="requestingOfficer" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="dateSubmission" class="block text-sm font-medium text-gray-700 mb-2">Date of Submission of Travel Report *</label>
          <input type="date" id="dateSubmission" required
            class="border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p id="dateSubmissionError" class="text-sm text-red-500 mt-1 hidden"></p>
        </div>

        <div class="flex space-x-4">
          <button type="submit" id="submitBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium transition">
            Create Travel Order
          </button>
          <button type="button" onclick="navigateToDashboard()"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-md font-medium transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let inclusiveDatePicker;
    let latestDatePrepared = null;

    function navigateToDashboard() {
      google.script.run.showDashboard();
    }

    function navigateToNewTo() {
      google.script.run.showNewToForm();
    }

    function loadLatestDatePrepared() {
      google.script.run.withSuccessHandler(function(latestDate) {
        latestDatePrepared = latestDate;
      }).getLatestDatePrepared();
    }

    function validateDatePrepared() {
      const datePreparedInput = document.getElementById('datePrepared');
      const datePreparedError = document.getElementById('datePreparedError');

      if (!datePreparedInput.value) return true;

      const datePrepared = new Date(datePreparedInput.value);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (datePrepared > today) {
        datePreparedError.textContent = 'Date Prepared cannot be in the future.';
        datePreparedError.classList.remove('hidden');
        datePreparedInput.classList.add('border-red-500');
        return false;
      }

      if (latestDatePrepared) {
        const latest = new Date(latestDatePrepared);
        if (datePrepared < latest) {
          datePreparedError.textContent = 'Date Prepared must be greater than or equal to the latest Date Prepared in the database.';
          datePreparedError.classList.remove('hidden');
          datePreparedInput.classList.add('border-red-500');
          return false;
        }
      }

      datePreparedError.classList.add('hidden');
      datePreparedInput.classList.remove('border-red-500');
      return true;
    }

    function validateInclusiveDates() {
      const inclusiveDatesInput = document.getElementById('inclusiveDates');
      const inclusiveDatesError = document.getElementById('inclusiveDatesError');
      const datePreparedInput = document.getElementById('datePrepared');

      if (!inclusiveDatesInput.value || !datePreparedInput.value) return true;

      const dates = inclusiveDatesInput.value.split(' to ');
      if (dates.length !== 2) return true;

      const datePrepared = new Date(datePreparedInput.value);
      const startDate = new Date(dates[0]);
      const endDate = new Date(dates[1]);

      if (startDate < datePrepared) {
        inclusiveDatesError.textContent = 'Start Date cannot be before Date Prepared.';
        inclusiveDatesError.classList.remove('hidden');
        inclusiveDatesInput.classList.add('border-red-500');
        return false;
      }

      if (endDate < startDate) {
        inclusiveDatesError.textContent = 'End Date cannot be before Start Date.';
        inclusiveDatesError.classList.remove('hidden');
        inclusiveDatesInput.classList.add('border-red-500');
        return false;
      }

      inclusiveDatesError.classList.add('hidden');
      inclusiveDatesInput.classList.remove('border-red-500');
      return true;
    }

    function validateDateSubmission() {
      const dateSubmissionInput = document.getElementById('dateSubmission');
      const dateSubmissionError = document.getElementById('dateSubmissionError');
      const inclusiveDatesValue = document.getElementById('inclusiveDates').value;

      if (!inclusiveDatesValue || !dateSubmissionInput.value) return true;

      const dates = inclusiveDatesValue.split(' to ');
      if (dates.length !== 2) return true;

      const endDate = new Date(dates[1]);
      const submissionDate = new Date(dateSubmissionInput.value);

      if (submissionDate < endDate) {
        dateSubmissionError.textContent = 'Submission date cannot be before End Date.';
        dateSubmissionError.classList.remove('hidden');
        dateSubmissionInput.classList.add('border-red-500');
        return false;
      }

      dateSubmissionError.classList.add('hidden');
      dateSubmissionInput.classList.remove('border-red-500');
      return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadLatestDatePrepared();

      const datePreparedInput = document.getElementById('datePrepared');
      if (datePreparedInput) {
        datePreparedInput.addEventListener('change', function() {
          validateDatePrepared();
          if (inclusiveDatePicker) {
            inclusiveDatePicker.set('minDate', this.value);
          }
        });
      }

      inclusiveDatePicker = flatpickr('#inclusiveDates', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        minDate: 'today',
        onChange: function(selectedDates) {
          validateInclusiveDates();
          if (selectedDates.length === 2) {
            const endDate = new Date(selectedDates[1]);
            const defaultSubmission = new Date(endDate);
            defaultSubmission.setDate(defaultSubmission.getDate() + 3);
            document.getElementById('dateSubmission').value = defaultSubmission.toISOString().split('T')[0];
            validateDateSubmission();
          }
        }
      });

      const dateSubmissionInput = document.getElementById('dateSubmission');
      if (dateSubmissionInput) {
        dateSubmissionInput.addEventListener('change', validateDateSubmission);
      }

      const toForm = document.getElementById('toForm');
      if (toForm) {
        toForm.addEventListener('submit', function(e) {
          e.preventDefault();

          if (!validateDatePrepared() || !validateInclusiveDates() || !validateDateSubmission()) {
            alert('Please fix the validation errors.');
            return;
          }

          const inclusiveDatesValue = document.getElementById('inclusiveDates').value;
          const dates = inclusiveDatesValue.split(' to ');

          if (dates.length !== 2) {
            alert('Please select both start and end dates.');
            return;
          }

          const formData = {
            datePrepared: new Date(document.getElementById('datePrepared').value).toISOString(),
            inclusiveStart: new Date(dates[0]).toISOString(),
            inclusiveEnd: new Date(dates[1]).toISOString(),
            dateSubmission: new Date(document.getElementById('dateSubmission').value).toISOString(),
            destination: document.getElementById('destination').value,
            purpose: document.getElementById('purpose').value,
            requestedBy: document.getElementById('requestedBy').value,
            requestingOfficer: document.getElementById('requestingOfficer').value
          };

          const submitBtn = document.getElementById('submitBtn');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Creating...';

          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                alert('Travel Order created successfully! TO ID: ' + result.toId);
                navigateToDashboard();
              } else {
                alert('Error: ' + result.error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Travel Order';
              }
            })
            .withFailureHandler(function(error) {
              alert('Error: ' + error);
              submitBtn.disabled = false;
              submitBtn.textContent = 'Create Travel Order';
            })
            .saveTravelOrder(formData);
        });
      }
    });
  </script>
</body>
</html>
